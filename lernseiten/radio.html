<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio: Ausgangslage Erbschaftssteuer - hep Verlag</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003876 0%, #5eb9b4 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #003876;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .audio-embed {
            background: #f8f9fa;
            border-left: 4px solid #5eb9b4;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .audio-embed h2 {
            color: #003876;
            margin-bottom: 15px;
        }

        .audio-container {
            position: relative;
            width: 100%;
            min-height: 200px;
            background: #e8e8e8;
            border-radius: 10px;
            overflow: hidden;
        }

        .audio-container iframe {
            width: 100%;
            min-height: 200px;
            border: none;
            border-radius: 10px;
        }

        .listening-indicator {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .listening-indicator.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .listening-icon {
            font-size: 24px;
        }

        .listening-text {
            flex: 1;
            font-size: 14px;
            color: #666;
        }

        .listening-indicator.completed .listening-text {
            color: #155724;
            font-weight: 600;
        }

        .timer-display {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            color: #003876;
        }

        .key-points {
            margin: 30px 0;
        }

        .key-points h2 {
            color: #003876;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .highlight-box {
            background: #e8f4f8;
            border-left: 5px solid #003876;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .highlight-box h3 {
            color: #003876;
            margin-bottom: 10px;
        }

        .quote {
            background: #f0f8f0;
            border-left: 5px solid #5eb9b4;
            padding: 20px;
            margin: 20px 0;
            font-style: italic;
            border-radius: 5px;
        }

        .quote::before {
            content: '"';
            font-size: 3em;
            color: #5eb9b4;
            line-height: 0;
            vertical-align: -0.4em;
        }

        .timeline {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .timeline h3 {
            color: #003876;
            margin-bottom: 20px;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #5eb9b4;
        }

        .timeline-year {
            font-weight: bold;
            color: #003876;
            min-width: 80px;
        }

        .timeline-text {
            flex: 1;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #003876, #5eb9b4);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .quiz-section {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 3px solid #5eb9b4;
            position: relative;
        }

        .quiz-section.locked {
            opacity: 0.5;
            pointer-events: none;
        }

        .quiz-lock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 10;
            display: none;
        }

        .quiz-section.locked .quiz-lock-overlay {
            display: block;
        }

        .quiz-section h2 {
            color: #003876;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .question {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .question.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question.answered {
            border-color: #5eb9b4;
        }

        .question h3 {
            color: #003876;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            background: white;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #5eb9b4;
            transform: translateX(5px);
        }

        .option.selected {
            background: #5eb9b4;
            color: white;
            border-color: #5eb9b4;
        }

        .option.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .option.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .next-button {
            background: #003876;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1em;
            transition: background 0.3s;
            display: none;
        }

        .next-button.show {
            display: inline-block;
        }

        .next-button:hover {
            background: #002855;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 30px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #003876, #5eb9b4);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            color: #003876;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .nav-button {
            background: #5eb9b4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background: #4a9a95;
        }

        .nav-button.secondary {
            background: #003876;
        }

        .nav-button.secondary:hover {
            background: #002855;
        }

        .completion-message {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
            display: none;
        }

        .completion-message.show {
            display: block;
        }

        .completion-message h3 {
            font-size: 2em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .statistics {
                grid-template-columns: 1fr;
            }

            .navigation {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Radio: Ausgangslage Erbschaftssteuer</h1>
            <p>Entwicklung der Erbschaftssteuer 1990-2019</p>
        </div>

        <div class="content">
            <div class="audio-embed">
                <h2>üìª Radiobeitrag</h2>
                <p><strong>Interview mit:</strong> Gisela H√ºrlimann, Wirtschaftshistorikerin</p>
                <p style="margin-bottom: 15px;"><strong>Thema:</strong> Historische Entwicklung der Erbschaftssteuer in der Schweiz</p>
                
                <div class="audio-container">
                    <iframe 
                        id="audioPlayer"
                        src="https://www.srf.ch/play/embed?urn=urn:srf:audio:4dabaa1b-a771-40d8-87ef-20e88d5170c1&subdivisions=false" 
                        allowfullscreen 
                        allow="geolocation *; autoplay; encrypted-media">
                    </iframe>
                </div>

                <div class="listening-indicator" id="listeningIndicator">
                    <span class="listening-icon">‚è±Ô∏è</span>
                    <span class="listening-text">
                        <strong>Wichtig:</strong> Bitte h√∂ren Sie den Radiobeitrag vollst√§ndig und ohne vorspulen an. 
                        Die Lernkontrollen werden anschliessend automatisch aufgeschaltet. Studieren Sie w√§hrend des Anh√∂rens die aufgef√ºhrten Kernaussagen.
                    </span>
                </div>
            </div>

            <div class="key-points">
                <h2>üîë Kernaussagen des Radiobeitrags</h2>

                <div class="statistics">
                    <div class="stat-card">
                        <div class="stat-number">‚Öì</div>
                        <div class="stat-label">Auf ein Drittel ist die Erbschaftssteuer zwischen 1990 und 2019 zur√ºckgegangen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">1798</div>
                        <div class="stat-label">Erste nationale Erbschaftssteuer in der Helvetischen Republik</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">1990</div>
                        <div class="stat-label">Steuerharmonisierungsgesetz erm√∂glicht Kantonen freie Hand</div>
                    </div>
                </div>

                <div class="highlight-box">
                    <h3>üèÜ Hauptgrund f√ºr den R√ºckgang</h3>
                    <p><strong>Interkantonaler Steuerwettbewerb</strong> ist laut Gisela H√ºrlimann der entscheidende Faktor:</p>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Zug und Schwyz waren besonders aggressive Steuerwettbewerber</li>
                        <li>Kantone senkten die Steuern, um verm√∂gende Personen anzuziehen</li>
                        <li>Das Steuerharmonisierungsgesetz von 1990 gab den Kantonen freie Hand</li>
                        <li>Direkte Nachkommen zahlen in vielen Kantonen heute keine Erbschaftssteuer mehr</li>
                    </ul>
                </div>

                <div class="timeline">
                    <h3>üìÖ Wichtige Meilensteine</h3>
                    <div class="timeline-item">
                        <div class="timeline-year">1798</div>
                        <div class="timeline-text">Erste nationale Erbschaftssteuer in der Helvetischen Republik</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">1973</div>
                        <div class="timeline-text">Initiative des Landesrings der Unabh√§ngigen (nahe Migros)</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">1990</div>
                        <div class="timeline-text">Steuerharmonisierungsgesetz erm√∂glicht Kantonen freie Hand bei Erbschaftssteuern</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">2019</div>
                        <div class="timeline-text">Erbschaftssteuer auf ein Drittel des Niveaus von 1990 zur√ºckgegangen</div>
                    </div>
                </div>

                <div class="quote">
                    Der interkantonale Steuerwettbewerb ist der Hauptgrund f√ºr den R√ºckgang der Erbschaftssteuern. Zug und Schwyz haben hier eine besonders aggressive Rolle gespielt.
                    <br><br><strong>‚Äî Gisela H√ºrlimann, Wirtschaftshistorikerin</strong>
                </div>

                <div class="highlight-box">
                    <h3>üìä Wer profitiert heute?</h3>
                    <p><strong>Direkte Nachkommen mit grossen Erbschaften</strong> profitieren am meisten:</p>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>In vielen Kantonen zahlen Kinder keine Erbschaftssteuer mehr</li>
                        <li>Die Verm√∂gensungleichheit ist heute st√§rker als in den 1970er Jahren</li>
                        <li>Grosse Verm√∂gen werden zunehmend innerhalb von Familien weitergegeben</li>
                        <li>Der Staat verzichtet auf erhebliche Einnahmen</li>
                    </ul>
                </div>

                <div class="highlight-box">
                    <h3>üîÑ Historischer Kontext</h3>
                    <p><strong>Die erste Erbschaftssteuer:</strong></p>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Wurde 1798 auf nationaler Ebene in der Helvetischen Republik eingef√ºhrt</li>
                        <li>War also urspr√ºnglich keine kantonale Steuer</li>
                        <li>Erst sp√§ter wurde die Kompetenz an die Kantone √ºbergeben</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Initiative von 1973:</strong></p>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Lanciert vom Landesring der Unabh√§ngigen (politisch nahe bei Migros)</li>
                        <li>Versuch, die Erbschaftssteuer zu st√§rken</li>
                        <li>Wurde vom Volk abgelehnt</li>
                    </ul>
                </div>

                <div class="highlight-box">
                    <h3>‚öñÔ∏è Folgen des R√ºckgangs</h3>
                    <p><strong>Was bedeutet der R√ºckgang um zwei Drittel?</strong></p>
                    <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Erheblich geringere Staatseinnahmen</li>
                        <li>Zunehmende Verm√∂genskonzentration</li>
                        <li>Entlastung vor allem f√ºr sehr verm√∂gende Familien</li>
                        <li>Schw√§chung des Instruments zur Umverteilung</li>
                    </ul>
                </div>
            </div>

            <div class="quiz-section locked" id="quizSection">
                <div class="quiz-lock-overlay">
                    <h3 style="color: #003876; margin-bottom: 15px;">üîí Quiz gesperrt</h3>
                    <p>Bitte h√∂ren Sie zuerst den Radiobeitrag<br>vollst√§ndig an, um das Quiz freizuschalten.</p>
                </div>

                <h2>üìù Kontrollfragen zum Radiobeitrag</h2>
                <div class="progress-text">Fortschritt: <span id="quiz-progress">0/6</span> Fragen beantwortet</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <!-- Frage 1 -->
                <div class="question active" data-question="1">
                    <h3>Frage 1 von 6: Zwischen welchen Jahren ist die Erbschaftssteuer laut dem Radiobeitrag auf ein Drittel zur√ºckgegangen?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">1970 und 2000</div>
                        <div class="option" data-answer="wrong">1980 und 2010</div>
                        <div class="option" data-answer="correct">1990 und 2019</div>
                        <div class="option" data-answer="wrong">2000 und 2025</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">N√§chste Frage ‚Üí</button>
                </div>

                <!-- Frage 2 -->
                <div class="question" data-question="2">
                    <h3>Frage 2 von 6: Was ist laut Gisela H√ºrlimann der Hauptgrund f√ºr den R√ºckgang der Erbschaftssteuern?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">Bundesgesetze zur Abschaffung</div>
                        <div class="option" data-answer="correct">Interkantonaler Steuerwettbewerb</div>
                        <div class="option" data-answer="wrong">Druck aus dem Ausland</div>
                        <div class="option" data-answer="wrong">Inflation und Wirtschaftskrise</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">N√§chste Frage ‚Üí</button>
                </div>

                <!-- Frage 3 -->
                <div class="question" data-question="3">
                    <h3>Frage 3 von 6: Wann wurde die erste Erbschaftssteuer in der Schweiz eingef√ºhrt?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">1848 bei der Gr√ºndung des Bundesstaats</div>
                        <div class="option" data-answer="correct">1798 in der Helvetischen Republik</div>
                        <div class="option" data-answer="wrong">1973 durch die Initiative des Landesrings</div>
                        <div class="option" data-answer="wrong">1990 durch das Steuerharmonisierungsgesetz</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">N√§chste Frage ‚Üí</button>
                </div>

                <!-- Frage 4 -->
                <div class="question" data-question="4">
                    <h3>Frage 4 von 6: Welche Partei lancierte 1973 eine Initiative zur Erbschaftssteuer?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">SP (Sozialdemokratische Partei)</div>
                        <div class="option" data-answer="correct">Landesring der Unabh√§ngigen (nahe Migros)</div>
                        <div class="option" data-answer="wrong">FDP (Freisinnig-Demokratische Partei)</div>
                        <div class="option" data-answer="wrong">CVP (Christlichdemokratische Volkspartei)</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">N√§chste Frage ‚Üí</button>
                </div>

                <!-- Frage 5 -->
                <div class="question" data-question="5">
                    <h3>Frage 5 von 6: Welche beiden Kantone werden als besonders aggressive Steuerwettbewerber genannt?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">Z√ºrich und Genf</div>
                        <div class="option" data-answer="wrong">Basel und Bern</div>
                        <div class="option" data-answer="correct">Zug und Schwyz</div>
                        <div class="option" data-answer="wrong">Waadt und Tessin</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">N√§chste Frage ‚Üí</button>
                </div>

                <!-- Frage 6 -->
                <div class="question" data-question="6">
                    <h3>Frage 6 von 6: Wer profitiert heute am meisten vom R√ºckgang der Erbschaftssteuern?</h3>
                    <div class="options">
                        <div class="option" data-answer="wrong">Kleine und mittlere Unternehmen</div>
                        <div class="option" data-answer="wrong">Die breite Mittelschicht</div>
                        <div class="option" data-answer="correct">Direkte Nachkommen mit grossen Erbschaften</div>
                        <div class="option" data-answer="wrong">Alle Steuerzahler gleichermassen</div>
                    </div>
                    <div class="feedback"></div>
                    <button class="next-button" onclick="showNextQuestion()">Quiz abschlie√üen ‚úì</button>
                </div>
            </div>

            <div class="completion-message" id="completion-message">
                <h3>üéâ Herzlichen Gl√ºckwunsch!</h3>
                <p>Sie haben alle Kontrollfragen zum Radiobeitrag bearbeitet.</p>
                <p style="margin-top: 15px;">Ihr Fortschritt wurde gespeichert.</p>
            </div>

            <div class="navigation">
                <a href="../index.html" class="nav-button secondary">‚Üê Zur√ºck zur √úbersicht</a>
                <a href="artikel1.html" class="nav-button">N√§chster Artikel ‚Üí</a>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
// === FIREBASE TRACKING - DASHBOARD-KOMPATIBEL ===

let pageStartTime = Date.now();
let currentQuestion = 1;
let answeredQuestions = new Set();
let correctQuizAnswers = 0;
const totalQuestions = 6;
let audioCompleted = false;

// Audio-Dauer: ca. 5 Minuten = 300 Sekunden
const AUDIO_DURATION = 300;
let timeWatched = 0;
let checkInterval;

// UserCode holen
function getUserCode() {
    return localStorage.getItem('userCode') || 'anonymous';
}

// === TRACKING FUNKTIONEN ===

// Page Visit tracken
function trackPageVisit(pageName) {
    const userCode = getUserCode();
    
    firebase.database().ref('users/' + userCode + '/visits/' + pageName).set({
        timestamp: Date.now(),
        page: pageName
    }).then(() => {
        console.log('‚úì Page visit tracked:', pageName);
    }).catch(err => {
        console.error('‚úó Error tracking visit:', err);
    });
}

// Media Watched tracken
function trackMediaWatched(pageName, mediaType, percentWatched) {
    const userCode = getUserCode();
    
    firebase.database().ref('users/' + userCode + '/media/' + pageName).set({
        mediaType: mediaType,
        percentWatched: percentWatched,
        timestamp: Date.now()
    }).then(() => {
        console.log('‚úì Media watched tracked:', percentWatched + '%');
    }).catch(err => {
        console.error('‚úó Error tracking media:', err);
    });
}

// Time Spent tracken
function trackTimeSpent(pageName) {
    const userCode = getUserCode();
    const timeSpent = Math.floor((Date.now() - pageStartTime) / 1000);
    
    firebase.database().ref('users/' + userCode + '/timeSpent/' + pageName).set({
        seconds: timeSpent,
        timestamp: Date.now()
    }).then(() => {
        console.log('‚úì Time spent tracked:', timeSpent, 'seconds');
    }).catch(err => {
        console.error('‚úó Error tracking time:', err);
    });
}

// Quiz Completion tracken
function trackQuizCompletion(pageName, correctAnswers, totalQuestions) {
    const userCode = getUserCode();
    
    firebase.database().ref('users/' + userCode + '/quizzes/' + pageName).set({
        correctAnswers: correctAnswers,
        totalQuestions: totalQuestions,
        timestamp: Date.now()
    }).then(() => {
        console.log('‚úì Quiz completion tracked:', correctAnswers, '/', totalQuestions);
    }).catch(err => {
        console.error('‚úó Error tracking quiz:', err);
    });
}

// Article Completion markieren
function markArticleComplete(pageName) {
    const userCode = getUserCode();
    
    firebase.database().ref('users/' + userCode + '/completions/' + pageName).set({
        completed: true,
        timestamp: Date.now()
    }).then(() => {
        console.log('‚úì Article marked as complete:', pageName);
    }).catch(err => {
        console.error('‚úó Error marking complete:', err);
    });
}

// === LOCALSTORAGE FUNKTIONEN ===

function getStorageKey(key) {
    const userCode = getUserCode();
    return `radio_${userCode}_${key}`;
}

function saveProgress() {
    localStorage.setItem(getStorageKey('audioCompleted'), audioCompleted);
    localStorage.setItem(getStorageKey('currentQuestion'), currentQuestion);
    localStorage.setItem(getStorageKey('answeredQuestions'), JSON.stringify([...answeredQuestions]));
    localStorage.setItem(getStorageKey('correctQuizAnswers'), correctQuizAnswers);
    console.log('‚úì Progress saved to localStorage');
}

function loadProgress() {
    const savedAudioCompleted = localStorage.getItem(getStorageKey('audioCompleted'));
    const savedCurrentQuestion = localStorage.getItem(getStorageKey('currentQuestion'));
    const savedAnsweredQuestions = localStorage.getItem(getStorageKey('answeredQuestions'));
    const savedCorrectAnswers = localStorage.getItem(getStorageKey('correctQuizAnswers'));
    
    let hasProgress = false;
    
    if (savedAudioCompleted === 'true') {
        audioCompleted = true;
        hasProgress = true;
    }
    
    if (savedCurrentQuestion) {
        currentQuestion = parseInt(savedCurrentQuestion);
        hasProgress = true;
    }
    
    if (savedAnsweredQuestions) {
        answeredQuestions = new Set(JSON.parse(savedAnsweredQuestions));
        hasProgress = true;
    }
    
    if (savedCorrectAnswers) {
        correctQuizAnswers = parseInt(savedCorrectAnswers);
        hasProgress = true;
    }
    
    return hasProgress;
}

function restoreUIState() {
    // Restore Audio Completion
    if (audioCompleted) {
        const indicator = document.getElementById('listeningIndicator');
        indicator.classList.add('completed');
        indicator.innerHTML = `
            <span class="listening-icon">‚úÖ</span>
            <span class="listening-text">
                Radiobeitrag vollst√§ndig angeh√∂rt! Das Quiz ist jetzt freigeschaltet.
            </span>
        `;
        document.getElementById('quizSection').classList.remove('locked');
    }
    
    // Restore Quiz
    if (answeredQuestions.size > 0) {
        document.querySelectorAll('.question').forEach((q, index) => {
            const qNum = (index + 1).toString();
            q.classList.toggle('active', index === currentQuestion - 1);
            
            if (answeredQuestions.has(qNum)) {
                q.classList.add('answered');
                const options = q.querySelectorAll('.option');
                options.forEach(opt => {
                    if (opt.classList.contains('correct') || opt.classList.contains('incorrect')) {
                        // Already has state
                    } else if (opt.dataset.answer === 'correct') {
                        opt.classList.add('correct');
                    }
                });
                
                const nextButton = q.querySelector('.next-button');
                if (nextButton) {
                    nextButton.classList.add('show');
                }
                
                const feedback = q.querySelector('.feedback');
                if (feedback && !feedback.classList.contains('show')) {
                    feedback.className = 'feedback correct show';
                    feedback.textContent = '‚úì Beantwortet';
                }
            }
        });
        updateProgress();
    }
    
    console.log('‚úì UI state restored from localStorage');
}

// === AUDIO TRACKING ===

function startAudioTracking() {
    checkInterval = setInterval(() => {
        if (!audioCompleted) {
            timeWatched += 5;
            
            if (timeWatched >= AUDIO_DURATION) {
                completeAudio();
            }
        }
    }, 5000);
}

function completeAudio() {
    if (audioCompleted) return;
    
    audioCompleted = true;
    clearInterval(checkInterval);
    
    // Visuelle Best√§tigung
    const indicator = document.getElementById('listeningIndicator');
    indicator.classList.add('completed');
    indicator.innerHTML = `
        <span class="listening-icon">‚úÖ</span>
        <span class="listening-text">
            Radiobeitrag vollst√§ndig angeh√∂rt! Das Quiz ist jetzt freigeschaltet.
        </span>
    `;
    
    // Quiz freischalten
    const quizSection = document.getElementById('quizSection');
    quizSection.classList.remove('locked');
    quizSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Firebase tracking
    trackMediaWatched('radio', 'audio', 100);
    
    // localStorage speichern
    saveProgress();
}

// === QUIZ ===

document.querySelectorAll('.option').forEach(option => {
    option.addEventListener('click', function() {
        if (!audioCompleted) return;
        
        const question = this.closest('.question');
        const questionNum = question.dataset.question;
        const options = question.querySelectorAll('.option');
        const feedback = question.querySelector('.feedback');
        const nextButton = question.querySelector('.next-button');
        
        if (answeredQuestions.has(questionNum)) return;
        
        options.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        
        const isCorrect = this.dataset.answer === 'correct';
        
        setTimeout(() => {
            if (isCorrect) {
                this.classList.add('correct');
                feedback.className = 'feedback correct show';
                feedback.textContent = '‚úì Richtig! ' + getCorrectFeedback(questionNum);
                correctQuizAnswers++;
            } else {
                this.classList.add('incorrect');
                options.forEach(opt => {
                    if (opt.dataset.answer === 'correct') {
                        opt.classList.add('correct');
                    }
                });
                feedback.className = 'feedback incorrect show';
                feedback.textContent = '‚úó Nicht ganz. ' + getCorrectFeedback(questionNum);
            }
            
            question.classList.add('answered');
            answeredQuestions.add(questionNum);
            nextButton.classList.add('show');
            updateProgress();
            saveProgress();
        }, 300);
    });
});

function showNextQuestion() {
    const currentQ = document.querySelector(`[data-question="${currentQuestion}"]`);
    currentQ.classList.remove('active');
    
    currentQuestion++;
    
    if (currentQuestion <= totalQuestions) {
        const nextQ = document.querySelector(`[data-question="${currentQuestion}"]`);
        nextQ.classList.add('active');
        saveProgress();
    } else {
        // Quiz abgeschlossen
        document.getElementById('completion-message').classList.add('show');
        
        // Tracking
        trackQuizCompletion('radio', correctQuizAnswers, totalQuestions);
        markArticleComplete('radio');
        trackTimeSpent('radio');
        
        saveProgress();
        
        console.log('üìä Final Stats - Radio:');
        console.log('  - Correct Quiz Answers:', correctQuizAnswers, '/', totalQuestions);
    }
}

function updateProgress() {
    const progress = (answeredQuestions.size / totalQuestions) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('quiz-progress').textContent = `${answeredQuestions.size}/${totalQuestions}`;
}

function getCorrectFeedback(questionNum) {
    const feedbacks = {
        '1': 'In diesem Zeitraum sank die Erbschaftssteuer in den Kantonen dramatisch auf nur noch ein Drittel des urspr√ºnglichen Niveaus.',
        '2': 'Der Wettbewerb zwischen den Kantonen um verm√∂gende Steuerzahler f√ºhrte zu einer Abw√§rtsspirale bei den Erbschaftssteuern.',
        '3': 'Die erste Erbschaftssteuer war eine nationale Steuer in der Helvetischen Republik ‚Äì erst sp√§ter wurde die Kompetenz an die Kantone √ºbergeben.',
        '4': 'Der Landesring der Unabh√§ngigen war eine politische Bewegung, die Migros nahestand. Die Initiative wurde vom Volk abgelehnt.',
        '5': 'Diese beiden Innerschweizer Kantone haben durch besonders niedrige Erbschaftssteuern verm√∂gende Personen angezogen und damit den Steuerwettbewerb angeheizt.',
        '6': 'In vielen Kantonen zahlen direkte Nachkommen heute keine oder nur noch sehr geringe Erbschaftssteuern, w√§hrend die Verm√∂gensungleichheit zunimmt.'
    };
    return feedbacks[questionNum] || '';
}

// === INITIALISIERUNG ===

window.addEventListener('load', () => {
    const userCode = getUserCode();
    console.log('=== RADIO GELADEN ===');
    console.log('User:', userCode);
    console.log('Tracking zu: users/' + userCode + '/');
    
    // Page Visit tracken
    trackPageVisit('radio');
    
    const hasProgress = loadProgress();
    if (hasProgress) {
        console.log('üîÑ Restoring previous progress...');
        restoreUIState();
    } else {
        console.log('üÜï Starting fresh');
    }
    
    // Audio Tracking starten (nur wenn noch nicht abgeschlossen)
    if (!audioCompleted) {
        startAudioTracking();
    }
});

// Beim Verlassen
window.addEventListener('beforeunload', () => {
    trackTimeSpent('radio');
});

// Auto-Save alle 30 Sekunden
setInterval(() => {
    saveProgress();
}, 30000);
    </script>
</body>
</html>
